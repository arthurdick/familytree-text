<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FTT Visualizer</title>
    
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <script src="js/FTTParser.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        #container { display: flex; height: 100vh; }
        
        /* Editor Pane */
        #editor-pane {
            width: 35%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            background: #f8f9fa;
        }
        
        #toolbar {
            padding: 10px 15px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #toolbar-group {
            display: flex;
            gap: 10px;
        }

        #editor {
            flex-grow: 1;
            width: 100%;
            border: none;
            resize: none;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            box-sizing: border-box;
            outline: none;
            color: #212529;
        }

        button {
            padding: 8px 16px;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s, transform 0.1s;
        }
        
        /* Render Button */
        #btn-render { background: #0d6efd; }
        #btn-render:hover { background: #0b5ed7; }
        #btn-render:active { transform: scale(0.98); }

        /* Export Button */
        #btn-export { background: #198754; }
        #btn-export:hover { background: #157347; }
        #btn-export:active { transform: scale(0.98); }

        /* Graph Pane */
        #cy {
            width: 65%;
            background: #ffffff;
            background-image: radial-gradient(#dee2e6 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Error Box */
        #error-box {
            color: #842029;
            background-color: #f8d7da;
            padding: 10px;
            font-size: 12px;
            display: none;
            border-top: 1px solid #f5c6cb;
            max-height: 120px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="editor-pane">
        <div id="toolbar">
            <span style="font-weight:600; color:#495057;">FTT Editor</span>
            <div id="toolbar-group">
                <button id="btn-render">Render Graph</button>
                <button id="btn-export">Export PNG</button>
            </div>
        </div>
        <textarea id="editor" spellcheck="false">
HEAD_FORMAT: FTT v0.1
HEAD_TITLE: Topology Test

ID: GRANDPA-01
NAME: Arthur Smith
BORN: 1920
UNION: GRANDMA-01 | MARR | 1945 ||

ID: GRANDMA-01
NAME: Mary Jones
BORN: 1922

ID: DAD-01
NAME: John Smith
BORN: 1950
# Note: Dad links to parents, but graph draws from Union Node
PARENT: GRANDPA-01 | BIO ||
PARENT: GRANDMA-01 | BIO ||
UNION: MOM-01 | MARR | 1975 ||

ID: MOM-01
NAME: Sarah Doe
BORN: 1952

ID: SON-01
NAME: Junior Smith
BORN: 1980
PARENT: DAD-01 | BIO ||
PARENT: MOM-01 | BIO ||
EVENT: OCC | 2005 || Engineer
</textarea>
        <div id="error-box"></div>
    </div>
    <div id="cy"></div>
</div>

<script>
    // 1. Initialize Parser
    const parser = new FTTParser();

    // 2. Converter Logic: FTT -> Cytoscape Elements
    function convertToCytoscape(parsedData) {
        const elements = [];
        const records = parsedData.records;
        const createdNodeIds = new Set(); // Track existence to prevent duplicates
        let unionCounter = 0;

        function addNode(id, label, subLabel, type, hidden = false) {
            // Prevent duplicate nodes
            if (createdNodeIds.has(id)) return;
            
            elements.push({
                data: { id, label, subLabel, type },
                classes: hidden ? 'hidden-node' : ''
            });
            createdNodeIds.add(id);
        }

        // Helper: Handle Implicit Placeholders (defined in Spec Section 8.3.4)
        // If an ID starts with '?', it might not have a record definition.
        // We must create a node for it on-the-fly if referenced.
        function ensurePlaceholderNode(id) {
            if (id && id.startsWith('?') && !createdNodeIds.has(id)) {
                addNode(id, id, '(Placeholder)', 'PLACEHOLDER');
            }
        }

        // --- Step A: Create Entity Nodes (Explicit Records) ---
        for (const [id, rec] of Object.entries(records)) {
            // FILTER: Skip Source and Event nodes to reduce clutter
            if (rec.type === 'SOURCE' || rec.type === 'EVENT') continue;

            let label = id;
            let subLabel = "";

            if (rec.type === 'INDIVIDUAL' || rec.type === 'PLACEHOLDER') {
                if (rec.data.NAME) label = rec.data.NAME[0].parsed[0] || id;
                if (rec.data.BORN && rec.data.BORN[0].parsed[0]) subLabel = `b. ${rec.data.BORN[0].parsed[0]}`;
            }
            
            addNode(id, label, subLabel, rec.type);
        }

        // --- Step B: Handle Relationships & Topology ---
        const parentPairToUnionNode = {}; 

        // 1. Process Unions
        for (const [id, rec] of Object.entries(records)) {
            if (rec.type === 'SOURCE' || rec.type === 'EVENT') continue;

            if (rec.data.UNION) {
                rec.data.UNION.forEach(u => {
                    const partnerId = u.parsed[0];
                    
                    // FIX: Ensure implicit placeholders exist before linking
                    ensurePlaceholderNode(partnerId);

                    // Verify partner exists (or was just created) and is not filtered
                    const partnerRec = records[partnerId];
                    // If it's a real record, ensure it's not a Source/Event. If it's implicit (undefined), allow it.
                    if (partnerRec && (partnerRec.type === 'SOURCE' || partnerRec.type === 'EVENT')) return;
                    if (!partnerRec && !partnerId.startsWith('?')) return; // dangling ref check

                    if (id < partnerId) {
                        const unionNodeId = `union_${unionCounter++}`;
                        const alignNodeId = `align_${unionNodeId}`;

                        parentPairToUnionNode[`${id}+${partnerId}`] = unionNodeId;
                        parentPairToUnionNode[`${partnerId}+${id}`] = unionNodeId;

                        // Union nodes are internal helpers, so we use a unique ID that won't conflict
                        elements.push({ data: { id: unionNodeId, label: '', type: 'UNION_NODE' } });
                        elements.push({ data: { id: alignNodeId, label: '', type: 'ALIGN_NODE' }, classes: 'hidden-node' });

                        // Skeleton Edges
                        [id, partnerId, unionNodeId].forEach(target => {
                            elements.push({ data: { source: alignNodeId, target: target }, classes: 'layout-edge' });
                        });

                        // Visual Edges
                        elements.push({ data: { source: id, target: unionNodeId }, classes: 'visual-edge' });
                        elements.push({ data: { source: partnerId, target: unionNodeId }, classes: 'visual-edge' });
                    }
                });
            }
        }

        // 2. Process Lineage
        for (const [childId, rec] of Object.entries(records)) {
            if (rec.type === 'SOURCE' || rec.type === 'EVENT') continue;

            if (rec.data.PARENT) {
                const bioParents = [];
                const otherParents = [];

                rec.data.PARENT.forEach(p => {
                    const pId = p.parsed[0];
                    const pType = (p.parsed[1] || 'BIO').toUpperCase();
                    
                    // FIX: Ensure implicit placeholders exist before linking
                    ensurePlaceholderNode(pId);

                    // Ensure parent is valid 
                    if (createdNodeIds.has(pId)) {
                        if (pType === 'BIO') {
                            bioParents.push(pId);
                        } else {
                            otherParents.push({ id: pId, type: pType });
                        }
                    }
                });

                // A. Handle BIO Parents
                if (bioParents.length >= 2) {
                    const unionKey = `${bioParents[0]}+${bioParents[1]}`;
                    if (parentPairToUnionNode[unionKey]) {
                        elements.push({ 
                            data: { source: parentPairToUnionNode[unionKey], target: childId }, 
                            classes: 'lineage-edge' 
                        });
                    } else {
                        // Fallback: Link directly to parents if no union node found (or more than 2 parents)
                        bioParents.forEach(pid => {
                            elements.push({ data: { source: pid, target: childId }, classes: 'lineage-edge' });
                        });
                    }
                } else if (bioParents.length === 1) {
                    elements.push({ data: { source: bioParents[0], target: childId }, classes: 'lineage-edge' });
                }

                // B. Handle Other Parents
                otherParents.forEach(op => {
                    elements.push({ 
                        data: { source: op.id, target: childId, label: op.type }, 
                        classes: 'other-parent-edge' 
                    });
                });
            }
        }

        // 3. Process Associates
        for (const [id, rec] of Object.entries(records)) {
            if (rec.type === 'SOURCE' || rec.type === 'EVENT') continue;

            if (rec.data.ASSOC) {
                rec.data.ASSOC.forEach(assoc => {
                    const targetId = assoc.parsed[0];
                    const role = assoc.parsed[1] || 'ASSOC';
                    
                    // FIX: Ensure implicit placeholders exist before linking
                    ensurePlaceholderNode(targetId);

                    if (createdNodeIds.has(targetId)) {
                        elements.push({
                            data: { source: id, target: targetId, label: role },
                            classes: 'assoc-edge'
                        });
                    }
                });
            }
        }
        
        return elements;
    }

    // 3. UI Logic
    document.addEventListener('DOMContentLoaded', () => {
        const editor = document.getElementById('editor');
        const btnRender = document.getElementById('btn-render');
        const btnExport = document.getElementById('btn-export');
        const errorBox = document.getElementById('error-box');

        const cy = cytoscape({
            container: document.getElementById('cy'),
            wheelSensitivity: 0.2,
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'text-valign': 'center', 'text-halign': 'center',
                        'color': '#333', 'font-size': '12px', 'font-weight': 'bold',
                        'width': 'label', 'height': 'label',
                        'padding': '12px',
                        'background-color': '#fff',
                        'border-width': 2, 'border-color': '#555',
                        'shape': 'round-rectangle'
                    }
                },
                {
                    selector: 'node[type="INDIVIDUAL"]',
                    style: {
                        'background-color': '#e7f5ff', 'border-color': '#1c7ed6',
                        'text-wrap': 'wrap',
                        'label': (n) => n.data('label') + (n.data('subLabel') ? '\n' + n.data('subLabel') : '')
                    }
                },
                {
                    selector: 'node[type="PLACEHOLDER"]',
                    style: {
                        'background-color': '#f8f9fa', 'border-color': '#adb5bd', 'border-style': 'dashed',
                        'text-wrap': 'wrap',
                        'label': (n) => n.data('label')
                    }
                },
                {
                    selector: 'node[type="UNION_NODE"]',
                    style: {
                        'width': 12, 'height': 12,
                        'background-color': '#cc5de8', 'border-width': 0,
                        'shape': 'diamond', 'label': ''
                    }
                },
                {
                    selector: '.hidden-node',
                    style: { 'visibility': 'hidden', 'width': 1, 'height': 1, 'display': 'none' }
                },
                {
                    selector: 'edge',
                    style: { 'curve-style': 'bezier' } 
                },
                {
                    selector: '.lineage-edge',
                    style: {
                        'width': 2, 'line-color': '#495057',
                        'curve-style': 'taxi', 'taxi-direction': 'vertical',
                        'target-arrow-color': '#495057', 'target-arrow-shape': 'triangle'
                    }
                },
                {
                    selector: '.visual-edge',
                    style: {
                        'width': 1.5, 'line-color': '#cc5de8',
                        'line-style': 'dashed',
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'none'
                    }
                },
                {
                    selector: '.assoc-edge',
                    style: {
                        'width': 1.5,
                        'line-color': '#fab005', 
                        'line-style': 'dotted',
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'none',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'color': '#d08800',
                        'text-background-opacity': 1,
                        'text-background-color': '#ffffff'
                    }
                },
                {
                    selector: '.other-parent-edge',
                    style: {
                        'width': 2,
                        'line-color': '#20c997', 
                        'line-style': 'dashed',
                        'curve-style': 'bezier',
                        'target-arrow-shape': 'triangle',
                        'target-arrow-color': '#20c997',
                        'label': 'data(label)',
                        'font-size': '10px',
                        'color': '#0ca678',
                        'text-background-opacity': 1,
                        'text-background-color': '#ffffff'
                    }
                },
                {
                    selector: '.layout-edge',
                    style: { 'display': 'none' }
                }
            ]
        });

        function render() {
            const result = parser.parse(editor.value);
            console.log(result);
            if (result.errors.length > 0) {
                errorBox.style.display = 'block';
                errorBox.innerHTML = '<strong>Errors:</strong><br>' + result.errors.join('<br>');
            } else {
                errorBox.style.display = 'none';
            }
            const cyElements = convertToCytoscape(result);
            cy.elements().remove();
            cy.add(cyElements);
            
            cy.layout({
                name: 'dagre',
                rankDir: 'TB',
                nodeSep: 60,
                rankSep: 80,
                edgeSep: 20,
                padding: 40
            }).run();
        }

        // --- EXPORT FUNCTIONALITY ---
        function exportImage() {
            const pngBlob = cy.png({
                full: true,
                output: 'blob',
                bg: 'white',
                scale: 2
            });

            const url = URL.createObjectURL(pngBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_tree.png';
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        btnRender.addEventListener('click', render);
        btnExport.addEventListener('click', exportImage);
        
        if(typeof FTTParser !== 'undefined') render();
    });
</script>

</body>
</html>
